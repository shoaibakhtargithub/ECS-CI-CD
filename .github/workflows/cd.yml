name: CD - Deploy to ECS using Terraform

on:
  # Automatically run after CI workflow finishes successfully
  workflow_run:
    workflows: ["CI - Build & Push Strapi Image to ECR"]
    types:
      - completed

  # Allow manual or infra‑level deployments
  push:
    branches:
      - main
    paths:
      - "terraform/**"
      - ".github/workflows/cd.yml"

  workflow_dispatch:

env:
  AWS_REGION: eu-north-1
  AWS_ACCOUNT_ID: "301782007642"
  ECR_REPOSITORY: shoaib-strapi-image
  CODEDEPLOY_APP: strapi-ecs-app-shoaib
  CODEDEPLOY_DG: strapi-dg

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    if: >
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Determine which image tag to deploy:
      # - For workflow_run: use the SHA of the CI workflow's commit (pre‑built image)
      # - For direct push / manual run: fall back to this workflow's commit SHA
      - name: Resolve image tag and URI
        id: vars
        env:
          GITHUB_SHA: ${{ github.sha }}
          WORKFLOW_RUN_SHA: ${{ github.event.workflow_run.head_sha || '' }}
        run: |
          if [ -n "$WORKFLOW_RUN_SHA" ]; then
            IMAGE_TAG="$WORKFLOW_RUN_SHA"
          else
            IMAGE_TAG="$GITHUB_SHA"
          fi

          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform
        env:
          IMAGE_URI: ${{ steps.vars.outputs.image_uri }}
        run: |
          terraform plan \
            -input=false \
            -var="image_uri=${IMAGE_URI}"

      - name: Terraform Apply
        working-directory: terraform
        env:
          IMAGE_URI: ${{ steps.vars.outputs.image_uri }}
        run: |
          terraform apply -auto-approve \
            -input=false \
            -var="image_uri=${IMAGE_URI}"

      - name: Prepare task definition JSON with image tag
        env:
          IMAGE_URI: ${{ steps.vars.outputs.image_uri }}
        run: |
          sed "s|IMAGE_URI|${IMAGE_URI}|g" \
            appspec/taskdef-template.json > taskdef.json

      - name: Register ECS task definition and capture ARN
        id: register_taskdef
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://taskdef.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)

          echo "task_def_arn=$TASK_DEF_ARN" >> "$GITHUB_OUTPUT"

      - name: Prepare AppSpec with new task definition ARN
        env:
          TASK_DEF_ARN: ${{ steps.register_taskdef.outputs.task_def_arn }}
        run: |
          sed "s|TASK_DEF_ARN|${TASK_DEF_ARN}|g" \
            appspec/appspec.yml > appspec/appspec-resolved.yml

      - name: Create CodeDeploy deployment
        id: create_deployment
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "$CODEDEPLOY_APP" \
            --deployment-group-name "$CODEDEPLOY_DG" \
            --revision revisionType=AppSpecContent,appSpecContent="{content=$(cat appspec/appspec-resolved.yml)}" \
            --region "$AWS_REGION" \
            --query "deploymentId" \
            --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"

      - name: Wait for deployment to complete (with rollback on failure)
        env:
          DEPLOYMENT_ID: ${{ steps.create_deployment.outputs.deployment_id }}
        run: |
          echo "Waiting for deployment $DEPLOYMENT_ID to finish..."
          set +e
          aws deploy wait deployment-successful \
            --deployment-id "$DEPLOYMENT_ID" \
            --region "$AWS_REGION"
          STATUS=$?
          set -e

          if [ "$STATUS" -ne 0 ]; then
            echo "Deployment failed. Auto-rollback is enabled in CodeDeploy deployment group."
            exit 1
          fi

